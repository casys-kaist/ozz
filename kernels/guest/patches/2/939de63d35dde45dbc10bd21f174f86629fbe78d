commit 939de63d35dde45dbc10bd21f174f86629fbe78d
Author: Miaohe Lin <linmiaohe@huawei.com>
Date:   Tue Aug 16 21:05:51 2022 +0800

    mm: hugetlb_vmemmap: add missing smp_wmb() before set_pte_at()
    
    The memory barrier smp_wmb() is needed to make sure that preceding stores
    to the page contents become visible before the below set_pte_at() write.
    
    Link: https://lkml.kernel.org/r/20220816130553.31406-5-linmiaohe@huawei.com
    Signed-off-by: Miaohe Lin <linmiaohe@huawei.com>
    Reviewed-by: Yin Fengwei <fengwei.yin@intel.com>
    Cc: Mike Kravetz <mike.kravetz@oracle.com>
    Cc: Muchun Song <songmuchun@bytedance.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>

diff --git a/mm/hugetlb_vmemmap.c b/mm/hugetlb_vmemmap.c
index 20f414c0379f..76b2d03a0d8d 100644
--- a/mm/hugetlb_vmemmap.c
+++ b/mm/hugetlb_vmemmap.c
@@ -287,6 +287,11 @@ static void vmemmap_restore_pte(pte_t *pte, unsigned long addr,
 	copy_page(to, (void *)walk->reuse_addr);
 	reset_struct_pages(to);
 
+	/*
+	 * Makes sure that preceding stores to the page contents become visible
+	 * before the set_pte_at() write.
+	 */
+	smp_wmb();
 	set_pte_at(&init_mm, addr, pte, mk_pte(page, pgprot));
 }
 
