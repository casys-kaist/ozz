#define _GNU_SOURCE
#include <unistd.h>
#include <arpa/inet.h>
#include <netinet/if_ether.h>
#include <linux/if_packet.h>
#include <pthread.h>

int fd;

void *packet_rx_ring(void *arg)
{
    struct tpacket_req3 tp;
    tp.tp_block_size = getpagesize();
    tp.tp_block_nr = 1;
    tp.tp_frame_size = getpagesize();
    tp.tp_frame_nr = 1;
    tp.tp_retire_blk_tov = 1000;
    setsockopt(fd, SOL_PACKET, PACKET_RX_RING, &tp, sizeof(tp));
    return NULL;
}

void *packet_version(void *arg)
{
    int val = TPACKET_V1;
    setsockopt(fd, SOL_PACKET, PACKET_VERSION, &val, sizeof(val));
    return NULL;
}

int main(int argc, char **argv)
{
    int val;
    pthread_t pth1, pth2;
    while(1) {
        fd = socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ARP));
        val = TPACKET_V3;
        setsockopt(fd, SOL_PACKET, PACKET_VERSION, &val, sizeof(val));
        pthread_create(&pth1, NULL, packet_rx_ring, NULL);
        pthread_create(&pth2, NULL, packet_version, NULL);
        pthread_join(pth1, NULL);
        pthread_join(pth2, NULL);
        close(fd);
    }
    return 0;
}
