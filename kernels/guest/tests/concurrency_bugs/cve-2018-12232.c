/*
socketpair$unix(0x1, 0x1, 0x0,
&(0x7f0000000000)={<r0=>0xffffffffffffffff, <r1=>0xffffffffffffffff})
getresuid(&(0x7f0000000080)=<r2=>0x0, &(0x7f00000000c0),
&(0x7f0000000700))r3 = getegid()
fchownat(r0, &(0x7f0000000040)='\x00', r2, r3, 0x1000)
dup3(r1, r0, 0x80000)
*/

#define _GNU_SOURCE

#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <pthread.h>
#include <unistd.h>

int fds[2];
void *fchownat_thread(void *arg)
{
	int r2, r3;
	r2 = getuid();
	r3 = getegid();
	fchownat(fds[0], "", r2, r3, 0x1000);
}

void *dup3_thread(void *arg)
{
	dup3(fds[1], fds[0], 0x80000);
}

int main(int argc, char *argv[])
{
	pthread_t pth[2];
	while (1) {
		if (!socketpair(AF_UNIX, SOCK_STREAM, 0x0, fds))
			perror("socketpair");
		
		pthread_create(&pth[0], NULL, fchownat_thread, NULL);
		pthread_create(&pth[1], NULL, dup3_thread, NULL);

		pthread_join(pth[0], NULL);
		pthread_join(pth[1], NULL);
	}
	return 0;
}
